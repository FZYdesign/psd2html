<!DOCTYPE html>  <html> <head>   <title>main</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="ControlUI.class.html">                 ControlUI.class.coffee               </a>                                           <a class="source" href="DialogUI.class.html">                 DialogUI.class.coffee               </a>                                           <a class="source" href="WindowUI.class.html">                 WindowUI.class.coffee               </a>                                           <a class="source" href="core.html">                 core.coffee               </a>                                           <a class="source" href="include_libraries.html">                 include_libraries.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               main             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">$.level = </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Global Settings</h2>

<p>単位をピクセルに</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">preferences.rulerUnits = </span><span class="nx">Units</span><span class="p">.</span><span class="nx">PIXELS</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Global Variables</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">originalWidth = </span><span class="mi">0</span>
<span class="nv">originalHeight = </span><span class="mi">0</span>
<span class="nv">currentWidth = </span><span class="mi">0</span>
<span class="nv">currentHeight = </span><span class="mi">0</span>
<span class="nv">offsetX = </span><span class="mi">0</span>
<span class="nv">offsetY = </span><span class="mi">0</span>
<span class="nv">saveFolder = </span><span class="kc">null</span>
<span class="nv">nameCounter = </span><span class="mi">0</span>
<span class="nv">structures = </span><span class="p">[]</span>
<span class="nv">fileNames = </span><span class="p">{}</span> <span class="c1"># ファイル名重複対策</span>
<span class="nv">fileNameCounter = </span><span class="mi">0</span> <span class="c1"># ファイル名重複対策</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Utility Function</h2>

<h3>数値処理拡張</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">Number</span><span class="o">::</span><span class="nv">fillZero = </span><span class="nf">(n) -&gt;</span>
  <span class="nv">zeros = </span><span class="k">new</span> <span class="nb">Array</span> <span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">@toString</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nx">length</span>
  <span class="nx">zeros</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Debug Function</h2>

<h3>ハッシュの出力用（再帰なし）</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">varDump = </span><span class="nf">(obj) -&gt;</span>
  <span class="nv">_rlt = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="k">own</span> <span class="nx">_key</span> <span class="k">of</span> <span class="nx">obj</span>
    <span class="k">try</span>
      <span class="nv">_val = </span><span class="nx">obj</span><span class="p">[</span><span class="nx">_key</span><span class="p">]</span>
      <span class="k">unless</span> <span class="nx">_val</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="k">then</span> <span class="nx">_rlt</span><span class="p">.</span><span class="nx">push</span> <span class="nx">_key</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">_val</span>
    <span class="k">catch</span> <span class="nx">error</span>
  <span class="nx">alert</span> <span class="nx">_rlt</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getLayerPath = </span><span class="nf">(layer) -&gt;</span>
  <span class="nv">path = </span><span class="p">[]</span>
  <span class="nv">getLayerName = </span><span class="nf">(layer) -&gt;</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">push</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">name</span>
    <span class="k">if</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">parent</span>
      <span class="nx">getLayerName</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">parent</span>
    <span class="k">return</span>
  <span class="nx">getLayerName</span> <span class="nx">layer</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>
  <span class="nb">encodeURI</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;/&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>保存</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">saveJPEG = </span><span class="nf">(fileName, dir = &#39;&#39;, quality = 80) -&gt;</span>
  <span class="nv">folder = </span><span class="k">new</span> <span class="nx">Folder</span> <span class="nx">saveFolder</span> <span class="o">+</span> <span class="nx">dir</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
  <span class="k">unless</span> <span class="nx">folder</span><span class="p">.</span><span class="nx">exists</span>
    <span class="nx">folder</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>
  <span class="nv">filePath = </span><span class="nx">folder</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">fileName</span> <span class="o">+</span> <span class="s">&#39;.jpg&#39;</span>
  <span class="nv">file = </span><span class="k">new</span> <span class="nx">File</span> <span class="nx">filePath</span>
  <span class="nv">jpegOpt = </span><span class="k">new</span> <span class="nx">JPEGSaveOptions</span><span class="p">()</span>
  <span class="nv">jpegOpt.embedColorProfile = </span><span class="kc">false</span>
  <span class="nv">jpegOpt.quality = </span><span class="nb">parseInt</span><span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="p">(</span><span class="nx">quality</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
  <span class="nv">jpegOpt.formatOptions = </span><span class="nx">FormatOptions</span><span class="p">.</span><span class="nx">OPTIMIZEDBASELINE</span>
  <span class="nv">jpegOpt.scans = </span><span class="mi">3</span>
  <span class="nv">jpegOpt.matte = </span><span class="nx">MatteType</span><span class="p">.</span><span class="nx">NONE</span>
  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">saveAs</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">jpegOpt</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Extension</span><span class="p">.</span><span class="nx">LOWERCASE</span>
  <span class="nx">file</span><span class="p">.</span><span class="nx">getRelativeURI</span> <span class="nx">saveFolder</span>

<span class="nv">saveGIF = </span><span class="nf">(fileName, dir = &#39;&#39;) -&gt;</span>
  <span class="nv">folder = </span><span class="k">new</span> <span class="nx">Folder</span> <span class="nx">saveFolder</span> <span class="o">+</span> <span class="nx">dir</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
  <span class="k">unless</span> <span class="nx">folder</span><span class="p">.</span><span class="nx">exists</span>
    <span class="nx">folder</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>
  <span class="nv">filePath = </span><span class="nx">folder</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">fileName</span> <span class="o">+</span> <span class="s">&#39;.gif&#39;</span>
  <span class="nv">file = </span><span class="k">new</span> <span class="nx">File</span> <span class="nx">filePath</span>
  <span class="nv">gifOpt = </span><span class="k">new</span> <span class="nx">GIFSaveOptions</span><span class="p">()</span>
  <span class="nv">gifOpt.colors = </span><span class="mi">32</span>
  <span class="nv">gifOpt.dither = </span><span class="nx">Dither</span><span class="p">.</span><span class="nx">NONE</span>
  <span class="nv">gifOpt.interlacted = </span><span class="kc">on</span>
  <span class="nv">gifOpt.matte = </span><span class="nx">MatteType</span><span class="p">.</span><span class="nx">WHITE</span>
  <span class="nv">gifOpt.palette = </span><span class="nx">Palette</span><span class="p">.</span><span class="nx">EXACT</span>
  <span class="nv">gifOpt.preserveExactColors = </span><span class="kc">off</span>
  <span class="nv">gifOpt.transparency = </span><span class="kc">on</span>
  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">saveAs</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">gifOpt</span><span class="p">,</span> <span class="kc">on</span><span class="p">,</span> <span class="nx">Extension</span><span class="p">.</span><span class="nx">LOWERCASE</span>
  <span class="nx">file</span><span class="p">.</span><span class="nx">getRelativeURI</span> <span class="nx">saveFolder</span>

<span class="nv">savePNG = </span><span class="nf">(fileName, dir = &#39;&#39;) -&gt;</span>
  <span class="nv">folder = </span><span class="k">new</span> <span class="nx">Folder</span> <span class="nx">saveFolder</span> <span class="o">+</span> <span class="nx">dir</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
  <span class="k">unless</span> <span class="nx">folder</span><span class="p">.</span><span class="nx">exists</span>
    <span class="nx">folder</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>
  <span class="nv">filePath = </span><span class="nx">folder</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">fileName</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span>
  <span class="nv">file = </span><span class="k">new</span> <span class="nx">File</span> <span class="nx">filePath</span>
  <span class="nv">pngOpt = </span><span class="k">new</span> <span class="nx">PNGSaveOptions</span>
  <span class="nv">pngOpt.interlaced = </span><span class="kc">off</span>
  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">saveAs</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">pngOpt</span><span class="p">,</span> <span class="kc">on</span><span class="p">,</span> <span class="nx">Extension</span><span class="p">.</span><span class="nx">LOWERCASE</span>
  <span class="nx">file</span><span class="p">.</span><span class="nx">getRelativeURI</span> <span class="nx">saveFolder</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>閉じる</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">close = </span><span class="nf">(showDialog = false) -&gt;</span>
  <span class="k">if</span> <span class="nx">showDialog</span>
    <span class="k">unless</span> <span class="nx">confirm</span> <span class="s">&#39;閉じてよろしいですか?&#39;</span>
      <span class="k">return</span>
  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">SaveOptions</span><span class="p">.</span><span class="nx">DONOTSAVECHANGES</span><span class="p">);</span>
  <span class="k">return</span>

<span class="nv">getBounds = </span><span class="nf">(layer) -&gt;</span>
  <span class="nv">bounds = </span><span class="nx">layer</span><span class="p">.</span><span class="nx">bounds</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nv">x: </span><span class="nb">parseInt</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span>
    <span class="nv">y: </span><span class="nb">parseInt</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span>
    <span class="nv">x2: </span><span class="nb">parseInt</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">10</span>
    <span class="nv">y2: </span><span class="nb">parseInt</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">10</span>
  <span class="p">}</span>

<span class="nv">enlargeForSelect = </span><span class="nf">(layer) -&gt;</span>
  <span class="nv">bounds = </span><span class="nx">getBounds</span> <span class="nx">layer</span>
  <span class="k">if</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="nx">currentWidth</span> <span class="o">-=</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span>
    <span class="nx">offsetX</span> <span class="o">+=</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span>
    <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">resizeCanvas</span> <span class="nx">currentWidth</span><span class="p">,</span> <span class="nx">currentHeight</span><span class="p">,</span> <span class="nx">AnchorPosition</span><span class="p">.</span><span class="nx">TOPRIGHT</span>
  <span class="k">if</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="nx">currentHeight</span> <span class="o">-=</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span>
    <span class="nx">offsetY</span> <span class="o">+=</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span>
    <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">resizeCanvas</span> <span class="nx">currentWidth</span><span class="p">,</span> <span class="nx">currentHeight</span><span class="p">,</span> <span class="nx">AnchorPosition</span><span class="p">.</span><span class="nx">BOTTOMLEFT</span>
  <span class="k">if</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">x2</span> <span class="o">&gt;</span> <span class="nx">currentWidth</span> <span class="o">+</span> <span class="nx">offsetX</span>
    <span class="nx">currentWidth</span> <span class="o">+=</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">x2</span> <span class="o">+</span> <span class="nx">offsetX</span>
    <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">resizeCanvas</span> <span class="nx">currentWidth</span><span class="p">,</span> <span class="nx">currentHeight</span><span class="p">,</span> <span class="nx">AnchorPosition</span><span class="p">.</span><span class="nx">TOPLEFT</span>
  <span class="k">if</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y2</span> <span class="o">&gt;</span> <span class="nx">currentHeight</span> <span class="o">+</span> <span class="nx">offsetY</span>
    <span class="nx">currentHeight</span> <span class="o">+=</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y2</span> <span class="o">+</span> <span class="nx">offsetY</span>
    <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">resizeCanvas</span> <span class="nx">currentWidth</span><span class="p">,</span> <span class="nx">currentHeight</span><span class="p">,</span> <span class="nx">AnchorPosition</span><span class="p">.</span><span class="nx">TOPLEFT</span>
  <span class="k">return</span> <span class="nx">bounds</span>

<span class="nv">restoreDimension = </span><span class="nf">-&gt;</span>
  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">resizeCanvas</span> <span class="nx">originalWidth</span> <span class="o">-</span> <span class="nx">offsetX</span><span class="p">,</span> <span class="nx">originalHeight</span> <span class="o">-</span> <span class="nx">offsetY</span><span class="p">,</span> <span class="nx">AnchorPosition</span><span class="p">.</span><span class="nx">TOPLEFT</span>
  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">resizeCanvas</span> <span class="nx">originalWidth</span><span class="p">,</span> <span class="nx">originalHeight</span><span class="p">,</span> <span class="nx">AnchorPosition</span><span class="p">.</span><span class="nx">BOTTOMRIGHT</span>

<span class="nv">selectAllLayers = </span><span class="nf">-&gt;</span>
  <span class="nv">ref = </span><span class="k">new</span> <span class="nx">ActionReference</span><span class="p">()</span>
  <span class="nx">ref</span><span class="p">.</span><span class="nx">putEnumerated</span> <span class="nx">charIDToTypeID</span><span class="p">(</span><span class="s">&#39;Lyr &#39;</span><span class="p">),</span> <span class="nx">charIDToTypeID</span><span class="p">(</span><span class="s">&#39;Ordn&#39;</span><span class="p">),</span> <span class="nx">charIDToTypeID</span><span class="p">(</span><span class="s">&#39;Trgt&#39;</span><span class="p">)</span>
  <span class="nv">desc = </span><span class="k">new</span> <span class="nx">ActionDescriptor</span><span class="p">()</span>
  <span class="nx">desc</span><span class="p">.</span><span class="nx">putReference</span> <span class="nx">charIDToTypeID</span><span class="p">(</span><span class="s">&#39;null&#39;</span><span class="p">),</span> <span class="nx">ref</span>
  <span class="nx">executeAction</span> <span class="nx">stringIDToTypeID</span><span class="p">(</span><span class="s">&#39;selectAllLayers&#39;</span><span class="p">),</span> <span class="nx">desc</span><span class="p">,</span> <span class="nx">DialogModes</span><span class="p">.</span><span class="nx">NO</span>
  <span class="k">return</span>

<span class="nv">isSelect = </span><span class="nf">-&gt;</span>
  <span class="nv">flag = </span><span class="kc">true</span>
  <span class="nv">_level = </span><span class="nx">$</span><span class="p">.</span><span class="nx">level</span>
  <span class="nv">$.level = </span><span class="mi">0</span>
  <span class="k">try</span>
    <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="nv">$.level = </span><span class="nx">_level</span>
    <span class="k">return</span> <span class="nv">flag = </span><span class="kc">false</span>
  <span class="k">finally</span>
    <span class="nv">$.level = </span><span class="nx">_level</span>
    <span class="k">return</span> <span class="nx">flag</span>
  <span class="k">return</span>

<span class="nv">copy = </span><span class="nf">(layer) -&gt;</span>
  <span class="nv">bounds = </span><span class="nx">enlargeForSelect</span> <span class="nx">layer</span>
  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">select</span> <span class="p">[</span>
    <span class="p">[</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>     <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>     <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
  <span class="p">]</span>
  <span class="nv">fillTransparent = </span><span class="kc">false</span>
  <span class="k">unless</span> <span class="nx">isSelect</span><span class="p">()</span>
    <span class="nv">black = </span><span class="k">new</span> <span class="nx">SolidColor</span>
    <span class="nv">black.model = </span><span class="nx">ColorModel</span><span class="p">.</span><span class="nx">RGB</span>
    <span class="nv">black.red = </span><span class="mi">0</span>
    <span class="nv">black.green = </span><span class="mi">0</span>
    <span class="nv">black.blue = </span><span class="mi">0</span>
    <span class="nv">dot = </span><span class="nx">activeDocument</span><span class="p">.</span><span class="nx">artLayers</span><span class="p">.</span><span class="nx">add</span><span class="p">()</span>
    <span class="nv">activeDocument.activeLayer = </span><span class="nx">dot</span>
    <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">fill</span> <span class="nx">black</span><span class="p">,</span> <span class="nx">ColorBlendMode</span><span class="p">.</span><span class="nx">NORMAL</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">false</span>
    <span class="nv">fillTransparent = </span><span class="kc">true</span>

  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">deselect</span><span class="p">()</span>

  <span class="nx">selectAllLayers</span><span class="p">()</span>

  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">select</span> <span class="p">[</span>
    <span class="p">[</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>  <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x2</span><span class="p">,</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x2</span><span class="p">,</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y2</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>  <span class="nx">bounds</span><span class="p">.</span><span class="nx">y2</span><span class="p">]</span>
  <span class="p">]</span>

  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">copy</span> <span class="kc">true</span>
  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">deselect</span><span class="p">()</span>

  <span class="nv">activeDocument.activeLayer = </span><span class="nx">layer</span>

  <span class="k">if</span> <span class="nx">dot</span>
    <span class="nx">dot</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>

  <span class="nv">dot = </span><span class="kc">null</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">gc</span><span class="p">()</span>

  <span class="nx">fillTransparent</span>

<span class="nv">paste = </span><span class="nf">(doc, fillTransparent) -&gt;</span>
  <span class="nx">doc</span><span class="p">.</span><span class="nx">paste</span><span class="p">()</span>

  <span class="nv">layer = </span><span class="nx">activeDocument</span><span class="p">.</span><span class="nx">activeLayer</span>
  <span class="nx">layer</span><span class="p">.</span><span class="nx">translate</span> <span class="o">-</span><span class="nx">layer</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="nx">layer</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">fillTransparent</span>
    <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">select</span> <span class="p">[</span>
      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
  <span class="nx">activeDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">deselect</span><span class="p">();</span>

  <span class="nv">doc = </span><span class="kc">null</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">gc</span><span class="p">()</span>
  <span class="k">return</span>

<span class="nv">getMetrics = </span><span class="nf">(layer) -&gt;</span>
  <span class="nv">bounds = </span><span class="nx">getBounds</span> <span class="nx">layer</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nv">x: </span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">offsetX</span>
    <span class="nv">y: </span><span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">offsetY</span>
    <span class="nv">width: </span><span class="nx">bounds</span><span class="p">.</span><span class="nx">x2</span> <span class="o">-</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">height: </span><span class="nx">bounds</span><span class="p">.</span><span class="nx">y2</span> <span class="o">-</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">y</span>
  <span class="p">}</span>

<span class="nv">createDocument = </span><span class="nf">(width, height, name) -&gt;</span>
  <span class="k">return</span> <span class="nx">documents</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">NewDocumentMode</span><span class="p">.</span><span class="nx">RGB</span><span class="p">,</span> <span class="nx">DocumentFill</span><span class="p">.</span><span class="nx">TRANSPARENT</span><span class="p">);</span>

<span class="nv">outputCSS = </span><span class="nf">(structures) -&gt;</span>
  <span class="nv">cssText = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">layer</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">structures</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>z = 10000 - i * 10</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">z = </span><span class="nx">i</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="nv">className = </span><span class="nx">layer</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\//g</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">).</span><span class="nx">replace</span> <span class="sr">/\.[a-z]+$/i</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
    <span class="nv">text =</span>
      <span class="s">&quot;&quot;&quot;</span>
<span class="s">      .</span><span class="si">#{</span><span class="nx">className</span><span class="si">}</span><span class="s"> \{</span>
<span class="s">        position: absolute;</span>
<span class="s">        top: </span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">y</span><span class="si">}</span><span class="s">px;</span>
<span class="s">        left: </span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">x</span><span class="si">}</span><span class="s">px;</span>
<span class="s">        z-index: </span><span class="si">#{</span><span class="nx">z</span><span class="si">}</span><span class="s">;</span>
<span class="s">        width: </span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">width</span><span class="si">}</span><span class="s">px;</span>
<span class="s">        height: </span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">height</span><span class="si">}</span><span class="s">px;</span>
<span class="s">        background: url(</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="s">) no-repeat scroll 0 0;</span>
<span class="s">      \}</span>
<span class="s">      &quot;&quot;&quot;</span>
    <span class="nx">cssText</span><span class="p">.</span><span class="nx">push</span> <span class="nx">text</span>
  <span class="nv">cssFile = </span><span class="k">new</span> <span class="nx">File</span> <span class="nx">saveFolder</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="s">&#39;style.css&#39;</span>
  <span class="nx">cssFile</span><span class="p">.</span><span class="nx">open</span> <span class="s">&#39;w&#39;</span>
  <span class="nv">cssFile.encoding = </span><span class="s">&#39;utf-8&#39;</span>
  <span class="nx">cssFile</span><span class="p">.</span><span class="nx">write</span> <span class="nx">cssText</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span>
  <span class="nx">cssFile</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>

  <span class="nv">cssText = </span><span class="kc">null</span>
  <span class="nv">cssFile = </span><span class="kc">null</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">gc</span><span class="p">()</span>

  <span class="nv">htmlTags = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">layer</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">structures</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>z = 10000 - i * 10</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">z = </span><span class="nx">i</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="nv">className = </span><span class="nx">layer</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\//g</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">).</span><span class="nx">replace</span> <span class="sr">/\.[a-z]+$/i</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
    <span class="nv">text =</span>
      <span class="s">&quot;&quot;&quot;</span>
<span class="s">        &lt;div class=&quot;</span><span class="si">#{</span><span class="nx">className</span><span class="si">}</span><span class="s">&quot;&gt;</span>
<span class="s">          &lt;!-- &lt;img class=&quot;</span><span class="si">#{</span><span class="nx">className</span><span class="si">}</span><span class="s">&quot; src=&quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="s">&quot; alt=&quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot; width=&quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">width</span><span class="si">}</span><span class="s">&quot; height=&quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">height</span><span class="si">}</span><span class="s">&quot;&gt; --&gt;</span>
<span class="s">          &lt;!-- &lt;div class=&quot;</span><span class="si">#{</span><span class="nx">className</span><span class="si">}</span><span class="s">&quot; data-src=&quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="s">&quot; data-width=&quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">width</span><span class="si">}</span><span class="s">&quot; data-height=&quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">height</span><span class="si">}</span><span class="s">&quot; data-x=&quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">x</span><span class="si">}</span><span class="s">&quot; data-y=&quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">y</span><span class="si">}</span><span class="s">&quot; data-z=&quot;</span><span class="si">#{</span><span class="nx">z</span><span class="si">}</span><span class="s">&quot;&gt;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&lt;div&gt; --&gt;</span>
<span class="s">        &lt;/div&gt;</span>
<span class="s">      &quot;&quot;&quot;</span>
    <span class="nx">htmlTags</span><span class="p">.</span><span class="nx">push</span> <span class="nx">text</span>
  <span class="nv">html =</span>
    <span class="s">&quot;&quot;&quot;</span>
<span class="s">    &lt;!doctype html&gt;</span>
<span class="s">    &lt;html&gt;</span>
<span class="s">    &lt;head&gt;</span>
<span class="s">      &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="s">      &lt;link rel=&quot;stylesheet&quot; href=&quot;style.css&quot;&gt;</span>
<span class="s">    $</span>
<span class="s">    &lt;/haed&gt;</span>
<span class="s">    &lt;body&gt;</span>
<span class="s">    &lt;/body&gt;</span>
<span class="s">    &lt;/html&gt;</span>
<span class="s">    &quot;&quot;&quot;</span>
  <span class="nv">htmlFile = </span><span class="k">new</span> <span class="nx">File</span> <span class="nx">saveFolder</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="s">&#39;index.html&#39;</span>
  <span class="nx">htmlFile</span><span class="p">.</span><span class="nx">open</span> <span class="s">&#39;w&#39;</span>
  <span class="nv">htmlFile.encoding = </span><span class="s">&#39;utf-8&#39;</span>
  <span class="nx">htmlFile</span><span class="p">.</span><span class="nx">write</span> <span class="nx">html</span><span class="p">.</span><span class="nx">replace</span> <span class="s">&#39;$&#39;</span><span class="p">,</span> <span class="nx">htmlTags</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span>
  <span class="nx">htmlFile</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>

  <span class="nv">htmlTags = </span><span class="kc">null</span>
  <span class="nv">html = </span><span class="kc">null</span>
  <span class="nv">htmlFile = </span><span class="kc">null</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">gc</span><span class="p">()</span>

  <span class="k">return</span>

<span class="nv">outputLESS = </span><span class="nf">(structures) -&gt;</span>
  <span class="nx">alert</span> <span class="s">&#39;LESSはまだつくってない&#39;</span>
  <span class="k">return</span>

<span class="nv">outputJSON = </span><span class="nf">(structures) -&gt;</span>
  <span class="nv">outputText = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">layer</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">structures</span>
    <span class="nv">z = </span><span class="mi">10000</span> <span class="o">-</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="nv">text =</span>
      <span class="s">&quot;&quot;&quot;</span>
<span class="s">      \{</span>
<span class="s">        &quot;name&quot;: &quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;,</span>
<span class="s">        &quot;className&quot;: &quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;,</span>
<span class="s">        &quot;x&quot;: </span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">x</span><span class="si">}</span><span class="s">,</span>
<span class="s">        &quot;y&quot;: </span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">y</span><span class="si">}</span><span class="s">,</span>
<span class="s">        &quot;z&quot;: </span><span class="si">#{</span><span class="nx">z</span><span class="si">}</span><span class="s">,</span>
<span class="s">        &quot;width&quot;: </span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">width</span><span class="si">}</span><span class="s">,</span>
<span class="s">        &quot;height&quot;: </span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">height</span><span class="si">}</span><span class="s">,</span>
<span class="s">        &quot;url&quot;: &quot;</span><span class="si">#{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="s">&quot;</span>
<span class="s">      \}</span>
<span class="s">      &quot;&quot;&quot;</span>
    <span class="nx">outputText</span><span class="p">.</span><span class="nx">push</span> <span class="nx">text</span>
  <span class="nv">outputFile = </span><span class="k">new</span> <span class="nx">File</span> <span class="nx">saveFolder</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="s">&#39;structures.json&#39;</span>
  <span class="nx">outputFile</span><span class="p">.</span><span class="nx">open</span> <span class="s">&#39;w&#39;</span>
  <span class="nv">outputFile.encoding = </span><span class="s">&#39;utf-8&#39;</span>
  <span class="nx">outputFile</span><span class="p">.</span><span class="nx">write</span> <span class="s">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">outputText</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;,\n&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;]&#39;</span>
  <span class="nx">outputFile</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>

  <span class="k">return</span>

<span class="nv">layerVisible = </span><span class="nf">(layer, visiblity, all = off) -&gt;</span>
  <span class="nv">parent = </span><span class="nx">layer</span><span class="p">.</span><span class="nx">parent</span>
  <span class="k">if</span> <span class="nx">parent</span>
    <span class="k">for</span> <span class="nx">sub</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">layers</span>
      <span class="nv">sub._v = </span><span class="nx">sub</span><span class="p">.</span><span class="nx">visible</span>
      <span class="k">if</span> <span class="nx">visiblity</span>
        <span class="nv">sub.visible = </span><span class="nx">sub</span><span class="p">.</span><span class="nx">_v</span>
      <span class="k">else</span>
        <span class="nv">sub.visible = </span><span class="kc">off</span>
    <span class="nx">layerVisible</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">visiblity</span><span class="p">,</span> <span class="kc">on</span>
    <span class="k">if</span> <span class="nx">visiblity</span>
      <span class="nv">parent.visible = </span><span class="kc">on</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">all</span> <span class="o">and</span> <span class="nx">visiblity</span>
    <span class="nv">layer.visible = </span><span class="kc">on</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>抽出</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">extract = </span><span class="nf">(layer, mix, extFlag) -&gt;</span>
  <span class="nv">name = </span><span class="nx">layer</span><span class="p">.</span><span class="nx">name</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>拡張子の分離</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nv">ext = </span><span class="nx">name</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/(\.(?:jpe?g|gif|png))$/i</span>
    <span class="nv">ext = </span><span class="nx">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">name = </span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">ext</span><span class="p">,</span> <span class="s">&#39;&#39;</span>

  <span class="nv">ext = </span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">extFlag</span> <span class="k">if</span> <span class="nx">extFlag</span>

  <span class="k">unless</span> <span class="nx">mix</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>自分以外を隠す</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">parent = </span><span class="nx">layer</span><span class="p">.</span><span class="nx">parent</span>
    <span class="k">if</span> <span class="nx">parent</span>
      <span class="k">for</span> <span class="nx">sub</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">layers</span>
        <span class="nv">sub._v = </span><span class="nx">sub</span><span class="p">.</span><span class="nx">visible</span>
        <span class="nv">sub.visible = </span><span class="kc">off</span>
      <span class="k">if</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span>
        <span class="k">for</span> <span class="nx">uncle</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">layers</span>
          <span class="nv">uncle._v = </span><span class="nx">uncle</span><span class="p">.</span><span class="nx">visible</span>
          <span class="nv">uncle.visible = </span><span class="kc">off</span>
      <span class="nv">parent.visible = </span><span class="kc">on</span>
    <span class="nv">layer.visible = </span><span class="kc">on</span>

  <span class="nv">dir = </span><span class="nx">getLayerPath</span> <span class="nx">layer</span>

  <span class="nv">name = </span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[0-9]/</span><span class="p">,</span> <span class="s">&#39;image$0&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^a-z0-9_\.:-]/gi</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">name</span> <span class="o">is</span> <span class="s">&#39;image&#39;</span>
    <span class="nv">name = </span><span class="s">&#39;image_&#39;</span> <span class="o">+</span> <span class="nx">nameCounter</span><span class="o">++</span>
  <span class="k">if</span> <span class="nx">fileNames</span><span class="p">[</span><span class="nx">dir</span> <span class="o">+</span> <span class="nx">name</span><span class="p">]</span>
    <span class="nx">name</span> <span class="o">+=</span> <span class="nx">fileNameCounter</span><span class="o">++</span>
  <span class="nx">fileNames</span><span class="p">[</span><span class="nx">dir</span> <span class="o">+</span> <span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">on</span>

  <span class="nv">fillTransparent = </span><span class="nx">copy</span> <span class="nx">layer</span>

  <span class="nv">metrics = </span><span class="nx">getMetrics</span> <span class="nx">layer</span>

  <span class="nv">newDoc = </span><span class="nx">createDocument</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">name</span>

  <span class="nx">paste</span> <span class="nx">newDoc</span><span class="p">,</span> <span class="nx">fillTransparent</span>

  <span class="k">if</span> <span class="nx">ext</span> <span class="o">is</span> <span class="s">&#39;.jpeg&#39;</span> <span class="o">or</span> <span class="nx">ext</span> <span class="o">is</span> <span class="s">&#39;.jpg&#39;</span>
    <span class="nv">url = </span><span class="nx">saveJPEG</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">dir</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">ext</span> <span class="o">is</span> <span class="s">&#39;.gif&#39;</span>
    <span class="nv">url = </span><span class="nx">saveGIF</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">dir</span>
  <span class="k">else</span>
    <span class="nv">url = </span><span class="nx">savePNG</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">dir</span>

  <span class="nx">newDoc</span><span class="p">.</span><span class="nx">close</span> <span class="nx">SaveOptions</span><span class="p">.</span><span class="nx">DONOTSAVECHANGES</span>

  <span class="nv">data = </span><span class="nx">metrics</span>
  <span class="nv">data.name = </span><span class="nx">name</span>
  <span class="nv">data.url = </span><span class="nx">url</span>

  <span class="nx">structures</span><span class="p">.</span><span class="nx">push</span> <span class="nx">data</span>

  <span class="k">unless</span> <span class="nx">mix</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>表示状態を元に戻す</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">parent = </span><span class="nx">layer</span><span class="p">.</span><span class="nx">parent</span>
    <span class="k">if</span> <span class="nx">parent</span>
      <span class="k">for</span> <span class="nx">sub</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">layers</span>
        <span class="nv">sub.visible = </span><span class="nx">sub</span><span class="p">.</span><span class="nx">_v</span>
      <span class="k">if</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span>
        <span class="k">for</span> <span class="nx">uncle</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">layers</span>
          <span class="nv">uncle.visible = </span><span class="nx">uncle</span><span class="p">.</span><span class="nx">_v</span>
  <span class="nv">parent = </span><span class="kc">null</span>
  <span class="nv">sub = </span><span class="kc">null</span>
  <span class="nv">uncle = </span><span class="kc">null</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">gc</span><span class="p">()</span>

  <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>アウトプット</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">output = </span><span class="nf">(layers, mix, ext) -&gt;</span>
  <span class="k">for</span> <span class="nx">layer</span> <span class="k">in</span> <span class="nx">layers</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>表示状態であり、フォルダレイヤーであれば再帰する</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">typename</span> <span class="o">is</span> <span class="s">&#39;LayerSet&#39;</span> <span class="o">and</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">visible</span>
      <span class="nx">output</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">layers</span><span class="p">,</span> <span class="nx">mix</span><span class="p">,</span> <span class="nx">ext</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>スマートオブジェクトであり、且つ表示状態であれば抽出する</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">visible</span> <span class="o">and</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">kind</span> <span class="o">is</span> <span class="nx">LayerKind</span><span class="p">.</span><span class="nx">SMARTOBJECT</span>
        <span class="nx">extract</span> <span class="nx">layer</span><span class="p">,</span> <span class="nx">mix</span><span class="p">,</span> <span class="nx">ext</span>
  <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>exec</h2>

<p>実行</p>

<p>@param {Number} typeFlag 出力タイプ
@param {String} ext 拡張子 <br />
@param {String} saveFolderPath 出力パス <br />
@param {Boolean} mix 背景を含めるかどうか</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exec = </span><span class="nf">(typeFlag, ext, saveFolderPath = &#39;~/&#39;, mix = false) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>カンバスサイズをメモ</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">originalWidth = </span><span class="nx">activeDocument</span><span class="p">.</span><span class="nx">width</span>
  <span class="nv">originalHeight = </span><span class="nx">activeDocument</span><span class="p">.</span><span class="nx">height</span>
  <span class="nv">currentWidth = </span><span class="nx">originalWidth</span>
  <span class="nv">currentHeight = </span><span class="nx">originalHeight</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>フォルダインスタンス</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">saveFolder = </span><span class="k">new</span> <span class="nx">Folder</span> <span class="nx">saveFolderPath</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>レイヤーの取得</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">layers = </span><span class="nx">activeDocument</span><span class="p">.</span><span class="nx">layers</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p><strong>画像の出力</strong> レイヤーの数だけ再帰</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">output</span> <span class="nx">layers</span><span class="p">,</span> <span class="nx">mix</span><span class="p">,</span> <span class="nx">ext</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h3>カンバスサイズをもとに戻す</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">restoreDimension</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>ガーベッジコレクション</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fileNames = </span><span class="kc">null</span>
  <span class="nv">layers = </span><span class="kc">null</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">gc</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p><strong>ここまでが画像の出力</strong></p>

<hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>取得したレイヤーを逆にする</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">structures</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>出力タイプにより出力</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">FLAG_CSS = </span><span class="mi">1</span>
  <span class="nv">FLAG_LESS = </span><span class="mi">2</span>
  <span class="nv">FLAG_JSON = </span><span class="mi">4</span>
  <span class="k">if</span> <span class="nx">typeFlag</span> <span class="o">&amp;</span> <span class="nx">FLAG_CSS</span>
    <span class="nx">outputCSS</span> <span class="nx">structures</span>
  <span class="k">if</span> <span class="nx">typeFlag</span> <span class="o">&amp;</span> <span class="nx">FLAG_JSON</span>
    <span class="nx">outputJSON</span> <span class="nx">structures</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h3>ガーベッジコレクション</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">structures = </span><span class="kc">null</span>
  <span class="nv">saveFolder = </span><span class="kc">null</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">gc</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h3>完了</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">alert</span> <span class="s">&#39;Complete!!&#39;</span>

  <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>入力ダイアログの表示</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">$dialog = </span><span class="k">new</span> <span class="nx">DialogUI</span> <span class="s">&#39;PSD to PNG&#39;</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="nx">@addText</span> <span class="s">&#39;書き出しフォルダ&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span>
  <span class="nv">$saveFolder = </span><span class="nx">@addTextbox</span> <span class="mi">540</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span>
  <span class="nx">@addButton</span> <span class="s">&#39;選択&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">610</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>
    <span class="nv">click: </span><span class="nf">-&gt;</span>
      <span class="nv">saveFolder = </span><span class="nx">Folder</span><span class="p">.</span><span class="nx">selectDialog</span> <span class="s">&#39;保存先のフォルダを選択してください&#39;</span>
      <span class="nx">$saveFolder</span><span class="p">.</span><span class="nx">val</span> <span class="nb">decodeURI</span> <span class="nx">saveFolder</span><span class="p">.</span><span class="nx">getRelativeURI</span> <span class="s">&#39;/&#39;</span> <span class="k">if</span> <span class="nx">saveFolder</span>
  <span class="nx">@addText</span> <span class="s">&#39;書き出し形式&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">160</span>
  <span class="nv">$types = </span><span class="p">[]</span>
  <span class="nx">$types</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@addCheckbox</span> <span class="s">&#39;HTML&amp;CSS&#39;</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">190</span>
  <span class="nx">$types</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@addCheckbox</span> <span class="s">&#39;LESS&#39;</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">190</span>
  <span class="nx">$types</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@addCheckbox</span> <span class="s">&#39;JSON&#39;</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">190</span>
  <span class="nx">@addText</span> <span class="s">&#39;オプション&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">230</span>
  <span class="nv">$mix = </span><span class="nx">@addCheckbox</span> <span class="s">&#39;背景やバウンディングボックスの範囲に入るオブジェクトも含めて書きだす。&#39;</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">260</span>
  <span class="nv">$png = </span><span class="nx">@addRadio</span> <span class="s">&#39;全ての画像を強制的にPNGで書き出す。&#39;</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">290</span>
  <span class="nv">$gif = </span><span class="nx">@addRadio</span> <span class="s">&#39;全ての画像を強制的にGIFで書き出す。&#39;</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">320</span>
  <span class="nx">@ok</span> <span class="nf">-&gt;</span>
    <span class="nv">saveFolderPath = </span><span class="nb">encodeURI</span> <span class="nx">$saveFolder</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
    <span class="nv">typeFlag = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">$type</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">$types</span>
      <span class="k">if</span> <span class="nx">$type</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
        <span class="nx">typeFlag</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">i</span>
    <span class="nv">ext = </span><span class="s">&#39;png&#39;</span> <span class="k">if</span> <span class="nx">$png</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
    <span class="nv">ext = </span><span class="s">&#39;gif&#39;</span> <span class="k">if</span> <span class="nx">$gif</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
    <span class="nx">@close</span><span class="p">()</span>
    <span class="nx">exec</span> <span class="nx">typeFlag</span><span class="p">,</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">saveFolderPath</span><span class="p">,</span> <span class="nx">$mix</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span> <span class="c1"># 実行</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 